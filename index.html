<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>é€æ˜Favicon æ’å…¥å·¥å…·</title>
  <style>
    body { 
      font-family: sans-serif; 
      padding: 2em; 
      background: #1e1e1e;
      color: #ffffff;
      display: flex;
      flex-direction: column;
      gap: 1em;
    }
    input[type="file"] { 
      border: 1px solid #444;
      padding: 5px;
      background: #333;
      color: #fff;
      cursor: pointer;
    }
    .button-group {
      display: flex;
      gap: 1em;
    }
    button {
      flex-grow: 1; /* è®“æŒ‰éˆ•å¹³å‡åˆ†é…ç©ºé–“ */
      padding: 10px 15px;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 1.0em;
      transition: background-color 0.3s;
    }
    #copyButton {
      background-color: #007bff; /* è¤‡è£½ (è—è‰²) */
    }
    #exportButton {
      background-color: #28a745; /* åŒ¯å‡º (ç¶ è‰²) */
    }
    button:hover:enabled {
      opacity: 0.85;
    }
    button:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }
    .status-message {
      margin-top: 1em;
      padding: 0.8em;
      background-color: #333;
      border: 1px solid #555;
      color: #ccc;
    }
  </style>
</head>
<body>
  <h1>é€æ˜Favicon æ’å…¥å·¥å…·</h1>
  
  <input type="file" id="fileInput" accept=".html" />
  
  <div class="button-group">
    <button id="copyButton" onclick="copyModified()" disabled>è¤‡è£½</button>
    <button id="exportButton" onclick="downloadModified()" disabled>åŒ¯å‡º</button>
  </div>
  
  <div id="statusMessage" class="status-message">è«‹ä¸Šå‚³ HTML æª”æ¡ˆã€‚</div>

  <script>
    // æ ¸å¿ƒæ’å…¥ç¨‹å¼ç¢¼
    const insertCode = '  <link id="favicon" rel="icon" href="" />';
    const scriptCode = `\n  <script>\n    const canvas = document.createElement('canvas');\n    canvas.width = canvas.height = 64;\n    const ctx = canvas.getContext('2d');\n    ctx.clearRect(0, 0, 64, 64);\n    document.getElementById('favicon').href = canvas.toDataURL();\n  <\/script>`;

    let modifiedContent = '';
    const copyButton = document.getElementById('copyButton');
    const exportButton = document.getElementById('exportButton');
    const statusMessage = document.getElementById('statusMessage');

    function updateButtons(isDisabled) {
        copyButton.disabled = isDisabled;
        exportButton.disabled = isDisabled;
        copyButton.textContent = 'è¤‡è£½'; // é‡ç½®æŒ‰éˆ•æ–‡å­—
    }

    document.getElementById('fileInput').addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (!file) return;

      statusMessage.textContent = `æ­£åœ¨è®€å–æª”æ¡ˆ: ${file.name}...`;
      updateButtons(true);

      const reader = new FileReader();
      reader.onload = function (event) {
        const content = event.target.result;
        
        let headInserted = false;
        let bodyInserted = false;

        // æ’å…¥ <link> åˆ° <head>
        let tempContent = content.replace(/<head[^>]*>/i, match => {
          headInserted = true;
          return match + '\n' + insertCode;
        });
        
        // æ’å…¥ <script> åˆ° </body>
        modifiedContent = tempContent.replace(/<\/body>/i, match => {
          bodyInserted = true;
          return scriptCode + '\n' + match;
        });

        if (!headInserted || !bodyInserted) {
          statusMessage.textContent = "âŒ éŒ¯èª¤ï¼šHTML çµæ§‹å¯èƒ½ä¸å®Œæ•´ï¼ŒæœªæˆåŠŸæ’å…¥ (ç¼ºå°‘ <head> æˆ– </body>)ã€‚";
        } else {
          statusMessage.textContent = `âœ… æª”æ¡ˆ "${file.name}" å·²æˆåŠŸä¿®æ”¹ï¼Œè«‹é¸æ“‡ã€Œè¤‡è£½ã€æˆ–ã€ŒåŒ¯å‡ºã€ã€‚`;
          updateButtons(false);
        }
      };
      reader.readAsText(file);
    });

    function copyModified() {
      if (!modifiedContent) return;
      
      navigator.clipboard.writeText(modifiedContent)
        .then(() => {
          // è¦–è¦ºå›é¥‹
          copyButton.textContent = 'å·²è¤‡è£½ï¼';
          setTimeout(() => { copyButton.textContent = 'è¤‡è£½'; }, 2000);
          statusMessage.textContent = 'ğŸ“‹ ä¿®æ”¹å¾Œçš„ç¨‹å¼ç¢¼å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ã€‚';
        })
        .catch(err => {
          console.error('è¤‡è£½å¤±æ•—:', err);
          statusMessage.textContent = 'âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ¬Šé™æˆ–å˜—è©¦ã€ŒåŒ¯å‡ºã€ã€‚';
        });
    }

    function downloadModified() {
      if (!modifiedContent) return;
      
      const blob = new Blob([modifiedContent], { type: "text/html" });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = "modified.html";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      
      statusMessage.textContent = "ğŸ‰ æª”æ¡ˆå·²åŒ¯å‡ºï¼è«‹æª¢æŸ¥æ‚¨çš„ä¸‹è¼‰è³‡æ–™å¤¾ã€‚";
    }
  </script>
</body>
</html>